<div class="reservas-container">

  <mat-card>

    <mat-card-header>
      <mat-card-title>

        <div class="header-content">
          <button mat-raised-button color="primary" (click)="abrirModalCrear()" [disabled]="parqueaderos.length === 0">
            <mat-icon>add</mat-icon>
            Nueva Reserva
          </button>
        </div>
    
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>

      @if (loading) {
        <div class="loading-container">
          <mat-spinner></mat-spinner>
          <p>Cargando reservas...</p>
        </div>

      } @else {
        @if (parqueaderos.length === 0) {
          <div class="no-data">
            <mat-icon>info</mat-icon>
            <p>No hay parqueaderos registrados para su empresa</p>
          </div>

        } @else {

          <app-filtro-parqueaderos
            [parqueaderos]="parqueaderos"
            [parqueaderoSeleccionado]="parqueaderoSeleccionado"
            (parqueaderoCambia)="onParqueaderoCambia($event)">
          </app-filtro-parqueaderos>

          @if (errorMessage) {
            <div class="mensaje-error">
              <mat-icon color="warn">error</mat-icon>
              <span>{{ errorMessage }}</span>
            </div>
          }

          @if (parqueaderoSeleccionado) {
            <div class="table-container">
              @if (mensajeExito) {
                <div class="mensaje-exito">
                  <mat-icon color="primary">check_circle</mat-icon>
                  <span>{{ mensajeExito }}</span>
                </div>
              }

              <table mat-table [dataSource]="reservas" class="reservas-table">
                
                <ng-container matColumnDef="id">
                  <th mat-header-cell *matHeaderCellDef>ID</th>
                  <td mat-cell *matCellDef="let reserva">{{ reserva.id }}</td>
                </ng-container>

                <ng-container matColumnDef="vehiculo">
                  <th mat-header-cell *matHeaderCellDef>Vehiculo</th>
                  <td mat-cell *matCellDef="let reserva">
                    @if (reserva.vehiculo?.placa) {
                      {{ reserva.vehiculo.placa }}
                    } @else {
                      ID: {{ reserva.idVehiculo }}
                    }
                  </td>
                </ng-container>

                <ng-container matColumnDef="fechaEntrada">
                  <th mat-header-cell *matHeaderCellDef>Fecha Entrada</th>
                  <td mat-cell *matCellDef="let reserva">{{ reserva.fechaEntrada | date:'short' }}</td>
                </ng-container>

                <ng-container matColumnDef="fechaSalida">
                  <th mat-header-cell *matHeaderCellDef>Fecha Salida</th>
                  <td mat-cell *matCellDef="let reserva">
                    @if (reserva.fechaSalida) {
                      {{ reserva.fechaSalida | date:'short' }}
                    } @else {
                      <span class="en-curso">En curso</span>
                    }
                  </td>
                </ng-container>

                <ng-container matColumnDef="estado">
                  <th mat-header-cell *matHeaderCellDef>Estado</th>
                  <td mat-cell *matCellDef="let reserva">
                    <mat-chip>
                      {{ reserva.estado }}
                    </mat-chip>
                  </td>
                </ng-container>

                <ng-container matColumnDef="acciones">
                  <th mat-header-cell *matHeaderCellDef>Acciones</th>
                  <td mat-cell *matCellDef="let reserva">
                    @if (reserva.estado === 'ABIERTA') {
                      <button 
                        mat-raised-button 
                        color="accent" 
                        (click)="finalizarReserva(reserva)"
                        class="accion-btn">
                        <mat-icon>check</mat-icon>
                        Finalizar
                      </button>
                    }
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
              </table>

              @if (reservas.length === 0) {
                <div class="sin-datos">
                  <mat-icon>info</mat-icon>
                  <p>No hay reservas registradas en este parqueadero</p>
                </div>
              }
            </div>


          }
        }
      }
    </mat-card-content>
  </mat-card>
</div>